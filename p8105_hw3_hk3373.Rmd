---
title: "P8105 Homework 3"
author: "Hyun Kim (hk3373)"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, echo = FALSE, message = FALSE}
library(tidyverse)
library(patchwork)
library(ggridges)

theme_set(theme_minimal() + 
  theme(legend.position = "bottom", 
      plot.title = element_text(hjust = 0.5)))
```

# Problem 1

## Load NY NOAA data:
```{r load_ny_noaa}
library(p8105.datasets)
data("ny_noaa")
str(ny_noaa)
```

The dataset has `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns, including 
id, tmax and tmin as character variables, precipitation, snow as integer 
variables,and date which is a date variable. There is a total of 
`r sum(is.na(ny_noaa))` NA values in the dataset. Therefore, this could be an 
issue in data analysis since there is a significant number of missing data. 

## Tidy NY NOAA: 
```{r tidy_ny_noaa}
ny_noaa = ny_noaa |>
  drop_na() |>
  mutate(
    prcp = prcp / 10,
    tmax = as.integer(tmax) / 10,
    tmin = as.integer(tmin) / 10
  ) |>
  separate(date, 
           into = c("year", "month", "day"), 
           sep = "-",
           remove = FALSE) 
```

In tidying the dataset, the values of precipitation and temperature were divided 
by 10 since they were in tenths of mm and degrees Celsius respectively. 

### For snowfall, what are the most commonly observed values? Why?
```{r most_common_snowfall}
ny_noaa |>
  group_by(snow) |>
  summarize(count = n()) |>
  arrange(desc(count)) |>
  slice(1)
```

For snowfall, the most commonly observed value is 0 because it only snows in 
winter, but the dataset includes data from the other three seasons when it 
most likely doesn't snow. 

## Average max temperature in January and July:
```{r avg_tmax_jan_july} 
ny_noaa |>
  filter(month %in% c("01","07")) |>
  mutate(
    month = recode(month, "01" = "January"),
    month = recode(month, "07" = "July")
  ) |>
  group_by(id, year, month) |>
  summarize(average_tmax = round(mean(tmax), 2)) |>
  ggplot(aes(x = year, y = average_tmax, color = month)) +
  geom_point() +
  facet_grid(~month) +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Average Max Temperature in January and July")
```

### Is there any observable / interpretable structure? Any outliers?

The average max temperature is noticeably higher in July compared to January 
obviously because it's summer during July and winter during January. Data for 
July 1988 has an extreme outlier. Data for January has noticeable outliers for 
several years; the most extreme outliers are shown in 1982 and 1996. 

## tmax vs tmin and snowfall distribution by year:
```{r tmax_tmin_snowfall, fig.width = 10, fig.asp = .7}
tmax_vs_tmin = 
  ny_noaa |>
  ggplot(aes(x = tmax, y = tmin)) + 
  geom_hex() +
  ggtitle("tmax vs tmin")

snowfall_dist = 
  ny_noaa |>
  filter(snow > 0, snow < 100) |>
  ggplot(aes(x = snow, y = year)) + 
  geom_density_ridges(scale = 1.5) +
  ggtitle("Snowfall Distribution by Year")

tmax_vs_tmin + snowfall_dist
```

According to the figure above, the values of tmax are concentrated around -5 to 
30 degrees Celsius, while the values of tmin are concentrated around -20 to 20 
degrees. The distribution of snowfall for all years are right skewed because it 
only snows during winter and it's subsequently more common for data in the 
dataset to have lower values of snowfall overall. 

# Problem 2

## Load, tidy and merge accelerometer datasets:
```{r load_tidy_merge_accel}
accel_df = read_csv(
  file = "./data/nhanes_accel.csv") |> 
  janitor::clean_names()

demographic_df = read_csv(
  file = "./data/nhanes_covar.csv",
  skip = 4,
  na = "NA") |> 
  janitor::clean_names() |>
  mutate(education = case_match(
             education,
             1 ~ "less than high school",
             2 ~ "high school equivalent",
             3 ~ "more than high school"),
         sex = case_match(
             sex,
             1 ~ "male",
             2 ~ "female"),
         education = as.factor(education),
         sex = as.factor(sex))

merged_accel_df = 
  left_join(accel_df, demographic_df, 
            by = join_by(seqn)) |>
  drop_na(sex, age, bmi, education) |>
  filter(age >= 21) |>
    pivot_longer(
    min1:min1440,
    names_to = "minute",
    names_prefix = "min",
    values_to = "activity") |>
  mutate(minute = as.numeric(minute))
```

## Number of men and women in each education category:
```{r men_women_education}
merged_accel_df |>
  distinct(seqn, .keep_all = TRUE) |>
  group_by(education, sex)|>
  summarize(num = n()) |>
  pivot_wider(
    names_from = "sex",
    values_from = "num"
  ) |> knitr::kable()
```

Approximately half of the participants have education more than high school. 
Also, for high school equivalent education, there are noticeably more males than 
females compared to the other two education levels. 

## Age distribution of men and women in each education category:
```{r age_distribution_education}
merged_accel_df |>
  distinct(seqn, .keep_all = TRUE) |>
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = .5) +
  facet_grid(~education) +
  ggtitle("Age Distribution by Education")
```

The distributions for females with education less than high school and high 
school equivalent are left skewed; however, the distributions for males with 
both educations are bimodal. On the other hand, the distribution for both 
females and males with education more than high school is right skewed. 

## Aggregate accross minute and plot total activities vs age:
```{r aggregate_activity_age}
merged_accel_df |>
  group_by(seqn, sex, age, education) |>
  summarize(total_activity = sum(activity)) |>
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE) +
  facet_grid(~education) +
  ggtitle("Age vs. Total Activity")
```

Total activity generally decreases as age increases, which is more noticable for 
less than high school and high school equivalent education, but less apparent in 
education more than high school. For data of male who has high school equivalent 
education, total activity increases until 40 and declines afterwards. 

## Plot 24-hour activity time courses for each eduction level:
```{r 24_hour_activity}
merged_accel_df |>
  arrange(minute) |>
  mutate(hour = rep(1:24, each = 13680)) |>
  group_by(seqn, sex, education, hour) |>
  summarize(activity = sum(activity)) |>
  ggplot(aes(y = activity, x = hour, color = sex)) +
  geom_point(size = .2, alpha = .5) +
  geom_smooth(se = FALSE) +
  facet_grid(~education)  +
  ggtitle("24-Hour Activity Time Course by Education")
```

For all education and sex, activity sharply increases after 5 AM when people 
start waking up possibly due to work and exercise and declines at 8 PM when 
people usually get back home from outdoor activities and start sleeping. Also, 
there is one extreme outlier for activity data of male who has more than high 
school education, which makes the range of the plot's y axis large for this 
three-panel plot.

# Problem 3

## Import, tidy and describe City Bike data:
```{r import_tidy_citybike}
jan_2020_df = read_csv(
    file = "./data/citibike/Jan 2020 Citi.csv"
  ) |> mutate(
    month = "January",
    year = 2020
  )
  
july_2020_df = read_csv(
    file = "./data/citibike/July 2020 Citi.csv",
  ) |> mutate(
    month = "July",
    year = 2020,
  )

jan_2024_df = read_csv(
    file = "./data/citibike/Jan 2024 Citi.csv"
  ) |> mutate(
    month = "January",
    year = 2024
  )

july_2024_df = read_csv(
    file = "./data/citibike/July 2024 Citi.csv"
  ) |> mutate(
    month = "July",
    year = 2024
  )

merged_citibike_df = 
  rbind(jan_2020_df, july_2020_df,
    jan_2024_df, july_2024_df) |>
  rename(membership = member_casual) |>
  mutate(weekdays = factor(weekdays, 
           c("Monday", "Tuesday", "Wednesday", 
          "Thursday", "Friday","Saturday", "Sunday")),
    rideable_type = as.factor(rideable_type),
    member_casual = as.factor(membership))

str(merged_citibike_df)
```

The dataset has `r nrow(merged_citibike_df)` rows and `r ncol(merged_citibike_df)`
columns, including ride id, start station name, end station name and month as 
character variables, and duration and year as numeric variables. Also, member 
casual was renamed to membership. Rideable type, weekdays and membership were 
converted to factor variables. 

## Total number of rides in each combination of year and month by membership:
```{r total_rides_by_date}
merged_citibike_df |>
  group_by(year, month, membership) |>
  summarize(total_rides = n()) |>
  pivot_wider(
    names_from = "membership",
    values_from = "total_rides"
  ) |>
  arrange(year) |>
  knitr::kable()
```

The table shows that there were significantly more rides by member riders 
compared to casual riders. July has higher numbers of rides suggesting that 
there are more rides in summer. Also, number of rides in the months of 2020 are 
lower compared to the months of 2024, possibly due to COVID-19. 

## 5 most popular starting stations for July 2024:
```{r popular_starting_stations}
merged_citibike_df |>
  filter(month == "July", year == 2024) |>
  group_by(start_station_name) |>
  summarize(total_rides = n()) |>
  arrange(desc(total_rides)) |>
  head(5) |>
  knitr::kable()
```

## Investigate effects of day of the week, month and year on median ride duration:
```{r median_ride_duration}
merged_citibike_df |>
  group_by(weekdays, month, year) |>
  summarize(median_duration = median(duration)) |>
  mutate(
    weekdays = recode(weekdays, "Monday" = "Mon"),
    weekdays = recode(weekdays, "Tuesday" = "Tue"),
    weekdays = recode(weekdays, "Wednesday" = "Wed"),
    weekdays = recode(weekdays, "Thursday" = "Thu"),
    weekdays = recode(weekdays, "Friday" = "Fri"),
    weekdays = recode(weekdays, "Saturday" = "Sat"),
    weekdays = recode(weekdays, "Sunday" = "Sun"),
  ) |>
  ggplot(aes(x = weekdays, y = median_duration, fill = month)) +
  geom_col(position = "dodge") +
  facet_grid(~year) +
  ggtitle("Effects of Day of the Week, Month and Year on Median Duration")
```

The median ride duration is higher during the weekends compared to weekdays. 
Also, the the median duration is significantly higher in July, especially for 
data in 2020. In terms of year, there is a decrease in the median from 2020 to 
2024. 

## Show the impact of month, membership and bike type:
```{r ride_duration_impact}
merged_citibike_df |>
  filter(year == 2024) |>
  ggplot(aes(x = membership, y = duration)) + 
  geom_violin(aes(fill = rideable_type), alpha = .5) +
  facet_grid(rideable_type~month) +
  ggtitle("Impact of Month, Membership and Bike Type on Ride Duration")
```

The plot indicates higher frequency of lower ride durations in 2024, as shown 
by the right skewed distributions for all months, membership and rideable type. 
Member riders have a higher frequency of lower ride durations compared to casual 
riders. For casual riders, there is a higher frequency of lower ride durations 
in January and electric bikes compared to July and classic bikes respectively. 
